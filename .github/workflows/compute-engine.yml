name: GCP Compute Engine - Basic Web App

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy
      confirm_destroy:
        description: 'Type "destroy" to confirm destruction'
        required: false
        default: ''

env:
  TF_VERSION: 1.9.0

# Prevent concurrent runs that could corrupt state
concurrency:
  group: terraform-${{ github.ref }}
  cancel-in-progress: false

jobs:
  terraform:
    name: Terraform ${{ github.event.inputs.action }}
    runs-on: ubuntu-latest
    
    # Restrict permissions (principle of least privilege)
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Check Permissions
        run: |
          if [ "${{ github.actor }}" != "marine9007" ]; then
            echo "âŒ ERROR: Unauthorized user."
            echo "This workflow can only be run by @marine9007"
            echo "Current user: @${{ github.actor }}"
            exit 1
          fi
          echo "âœ… User authorized: @${{ github.actor }}"
      
      - name: Validate Destroy Confirmation
        if: github.event.inputs.action == 'destroy'
        run: |
          if [ "${{ github.event.inputs.confirm_destroy }}" != "destroy" ]; then
            echo "âŒ ERROR: Destroy action requires confirmation."
            echo "Please type 'destroy' in the confirm_destroy field."
            exit 1
          fi
          echo "âœ… Destroy confirmation validated"
      
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          # Prevent credential leakage in logs
          export_environment_variables: false
          create_credentials_file: true
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: Terraform Format Check
        run: terraform fmt -check
        continue-on-error: true
      
      - name: Terraform Init
        id: init
        run: terraform init
        continue-on-error: false
      
      - name: Terraform Validate
        id: validate
        run: terraform validate
        continue-on-error: false
      
      - name: Terraform Plan
        if: github.event.inputs.action == 'plan'
        id: plan
        run: terraform plan
        continue-on-error: false
      
      - name: Terraform Apply
        if: github.event.inputs.action == 'apply'
        id: apply
        run: |
          echo "ðŸ“‹ Generating plan..."
          terraform plan -out=tfplan || exit 1
          echo "ðŸš€ Applying infrastructure..."
          terraform apply -auto-approve tfplan || exit 1
          echo "âœ… Apply complete!"
          echo ""
          echo "ðŸ“Š Outputs:"
          terraform output
          
          # Capture outputs for summary
          echo "WEBAPP_URL=$(terraform output -raw webapp_url 2>/dev/null || echo 'N/A')" >> $GITHUB_ENV
          echo "PUBLIC_IP=$(terraform output -raw public_ip 2>/dev/null || echo 'N/A')" >> $GITHUB_ENV
          echo "INSTANCE_NAME=$(terraform output -raw instance_name 2>/dev/null || echo 'N/A')" >> $GITHUB_ENV
          echo "NETWORK_NAME=$(terraform output -raw network_name 2>/dev/null || echo 'N/A')" >> $GITHUB_ENV
      
      - name: Terraform Destroy
        if: github.event.inputs.action == 'destroy'
        id: destroy
        run: |
          echo "âš ï¸  WARNING: Destroying all infrastructure..."
          terraform destroy -auto-approve || exit 1
          echo "âœ… Destroy complete!"
      
      - name: Workflow Summary
        if: always()
        run: |
          echo "## ðŸ“Š Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Execution Details" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Action** | \`${{ github.event.inputs.action }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered by** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Timestamp** | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| **Duration** | 41s |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.action }}" = "plan" ] && [ "${{ steps.plan.outcome }}" = "success" ]; then
            echo "### ðŸ“‹ Plan Results" >> $GITHUB_STEP_SUMMARY
            echo "Terraform plan executed successfully." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### ðŸŽ¯ Deployment Target" >> $GITHUB_STEP_SUMMARY
            echo "| Resource | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| **GCP Project** | \`marine9007\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Region** | \`us-central1\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Zone** | \`us-central1-a\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Instance Type** | \`e2-micro\` (FREE TIER) |" >> $GITHUB_STEP_SUMMARY
            echo "| **Instance Name** | \`basic-webapp-instance\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Network** | \`basic-webapp-network\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Firewall Rules** | HTTP/HTTPS (80, 443), SSH (22) |" >> $GITHUB_STEP_SUMMARY
            echo "| **OS Image** | Debian 11 |" >> $GITHUB_STEP_SUMMARY
            echo "| **Disk Size** | 10 GB standard persistent disk |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### ðŸ“Š Resources to be Created" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… VPC Network (\`basic-webapp-network\`)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Firewall Rule - HTTP/HTTPS (\`basic-webapp-allow-http\`)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Firewall Rule - SSH (\`basic-webapp-allow-ssh\`)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Compute Engine Instance (\`basic-webapp-instance\`)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Ephemeral Public IP (auto-assigned)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "**ðŸ’° Estimated Cost**: \$0/month (FREE TIER)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Review the detailed plan output in the job logs above before running \`apply\`." >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ github.event.inputs.action }}" = "apply" ] && [ "${{ steps.apply.outcome }}" = "success" ]; then
            echo "### âœ… Apply Results" >> $GITHUB_STEP_SUMMARY
            echo "Infrastructure successfully deployed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### ðŸŒ Deployed Infrastructure" >> $GITHUB_STEP_SUMMARY
            echo "| Resource | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| **GCP Project** | \`marine9007\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Region** | \`us-central1\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Zone** | \`us-central1-a\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Instance Type** | \`e2-micro\` (FREE TIER) |" >> $GITHUB_STEP_SUMMARY
            echo "| **Instance Name** | \`${{ env.INSTANCE_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Network** | \`${{ env.NETWORK_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Public IP** | \`${{ env.PUBLIC_IP }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **OS Image** | Debian 11 |" >> $GITHUB_STEP_SUMMARY
            echo "| **Disk Size** | 10 GB |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### ðŸ”— Access Information" >> $GITHUB_STEP_SUMMARY
            echo "| Type | Link/Command |" >> $GITHUB_STEP_SUMMARY
            echo "|------|--------------|" >> $GITHUB_STEP_SUMMARY
            echo "| **Web App URL** | [${{ env.WEBAPP_URL }}](${{ env.WEBAPP_URL }}) |" >> $GITHUB_STEP_SUMMARY
            echo "| **GCP Console** | [View Instance](https://console.cloud.google.com/compute/instances?project=marine9007) |" >> $GITHUB_STEP_SUMMARY
            echo "| **SSH Command** | \`gcloud compute ssh ${{ env.INSTANCE_NAME }} --zone=us-central1-a --project=marine9007\` |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### ðŸ’° Cost Information" >> $GITHUB_STEP_SUMMARY
            echo "- **Estimated Cost**: \$0/month (FREE TIER)" >> $GITHUB_STEP_SUMMARY
            echo "- **Instance**: 1x e2-micro in us-central1 (Always Free)" >> $GITHUB_STEP_SUMMARY
            echo "- **Network Egress**: Free up to 1 GB/month" >> $GITHUB_STEP_SUMMARY
            echo "- **Storage**: 10 GB standard persistent disk (free)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Access your web app: ${{ env.WEBAPP_URL }}" >> $GITHUB_STEP_SUMMARY
            echo "2. Monitor in [GCP Console](https://console.cloud.google.com/compute/instances?project=marine9007)" >> $GITHUB_STEP_SUMMARY
            echo "3. View logs in [Cloud Logging](https://console.cloud.google.com/logs?project=marine9007)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ github.event.inputs.action }}" = "destroy" ] && [ "${{ steps.destroy.outcome }}" = "success" ]; then
            echo "### ðŸ—‘ï¸ Destroy Results" >> $GITHUB_STEP_SUMMARY
            echo "Infrastructure successfully destroyed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All resources have been removed from GCP." >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ job.status }}" = "failure" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âŒ Failure Details" >> $GITHUB_STEP_SUMMARY
            echo "The workflow failed. Check the job logs above for detailed error messages." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Common Issues:**" >> $GITHUB_STEP_SUMMARY
            echo "- Validate \`GCP_SA_KEY\` secret is set correctly" >> $GITHUB_STEP_SUMMARY
            echo "- Check service account has required permissions" >> $GITHUB_STEP_SUMMARY
            echo "- Verify Terraform configuration syntax" >> $GITHUB_STEP_SUMMARY
            echo "- Ensure GCP quotas are not exceeded" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Workflow: GCP Compute Engine - Basic Web App*" >> $GITHUB_STEP_SUMMARY

